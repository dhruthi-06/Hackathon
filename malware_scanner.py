import os
import yara

def compile_yara_rules():
    rules = """
    rule MalwareExample
    {
        strings:
            $a = "malicious_code_signature"
        condition:
            $a
    }
    """
    return yara.compile(source=rules)

def scan_files(directory, yara_rules):
    matches = []
    for root, _, files in os.walk(directory):
        for file in files:
            try:
                file_path = os.path.join(root, file)
                print(f"Scanning file: {file_path}")
                file_matches = yara_rules.match(filepath=file_path)
                if file_matches:
                    print(f"Malware found in file: {file_path}")
                    for match in file_matches:
                        match.meta['filepath'] = file_path  # Add file path to match metadata
                    matches.extend(file_matches)
            except Exception as e:
                print(f"Error scanning {file_path}: {e}")
    return matches

def generate_report(matches):
    report = "Malware Detection Report:\n"
    if matches:
        for match in matches:
            report += f"File: {match.meta['filepath']} \nmatched with rule: {match.rule}\nMalware Found"
    else:
        report += "No malware found."
    with open("report.txt", "w") as report_file:
        report_file.write(report)

if _name_ == "_main_":
    yara_rules = compile_yara_rules()
    directory_to_scan = "C:/Users/adith/Downloads/Networking&Cybersecurity_Stories"  
    matches = scan_files(directory_to_scan, yara_rules)
    generate_report(matches)
    print("Scan complete. Report generated.")
